___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Designeo cookiesConsent Template",
  "brand": {
    "id": "brand_dummy",
    "displayName": "Designeo",
    "thumbnail": "data:image/jpeg;base64,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\u003d\u003d"
  },
  "description": "https://github.com/ArtemKolychev/designeo-cookies-consent-GTM",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "automaticLang",
    "displayName": "automaticLang",
    "simpleValueType": true,
    "canBeEmptyString": false
  },
  {
    "type": "TEXT",
    "name": "defaultLang",
    "displayName": "default lang",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "overideLang",
    "displayName": "overide lang",
    "simpleValueType": true,
    "canBeEmptyString": true
  },
  {
    "type": "SELECT",
    "name": "ad_storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "granted",
        "displayValue": "granted"
      }
    ],
    "simpleValueType": true,
    "displayName": "ad_storage",
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "analytics_storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "granted",
        "displayValue": "granted"
      }
    ],
    "simpleValueType": true,
    "displayName": "analytics_storage",
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "functionality_storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "granted",
        "displayValue": "granted"
      }
    ],
    "simpleValueType": true,
    "displayName": "ad_storage",
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "personalization_storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "granted",
        "displayValue": "granted"
      }
    ],
    "simpleValueType": true,
    "displayName": "personalization_storage",
    "defaultValue": "denied"
  },
  {
    "type": "SELECT",
    "name": "security_storage",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "denied"
      },
      {
        "value": "granted",
        "displayValue": "granted"
      }
    ],
    "simpleValueType": true,
    "displayName": "security_storage",
    "defaultValue": "granted"
  },
  {
    "type": "PARAM_TABLE",
    "name": "policyUrls",
    "displayName": "",
    "paramTableColumns": [
      {
        "param": {
          "type": "TEXT",
          "name": "lang",
          "displayName": "lang",
          "simpleValueType": true
        },
        "isUnique": false
      },
      {
        "param": {
          "type": "TEXT",
          "name": "link",
          "displayName": "link",
          "simpleValueType": true
        },
        "isUnique": false
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
const callInWindow = require('callInWindow');
const copyFromWindow = require('copyFromWindow');
const makeTableMap = require('makeTableMap');
const injectScript = require('injectScript');
const setDefaultConsentState = require('setDefaultConsentState');
const getCookieValues = require('getCookieValues');
const JSON = require('JSON');
const createQueue = require('createQueue');
const dataLayerPush = createQueue('dataLayer');

log('data =', data);

let storage = getCookieValues('cookie_consent_level');

const getPolicyUrl = (actualLang) => {
  if(!data.policyUrls){
    return null;
  }
  const policyData = makeTableMap(data.policyUrls, "lang", "link");
  if (policyData) {
    return policyData[actualLang];
  }
  return null;
};

const getConfirmState = (storage, type) => {
  let isConfirm;
  if (storage[type] === undefined) {
    return "denied";
  } else {
    isConfirm = storage[type];
  }
  return isConfirm ? "granted" : "denied";
};

if (storage.length > 0) {
  storage = JSON.parse(storage[0]
    .replace('strictly-necessary', 'security_storage')
    .replace('functionality', 'functionality_storage')
    .replace('targeting', 'ad_storage')
    .replace('tracking', 'analytics_storage')
  );
}

setDefaultConsentState({
  ad_storage: getConfirmState(storage, 'ad_storage'),
  analytics_storage: getConfirmState(storage, 'analytics_storage'),
  functionality_storage: getConfirmState(storage, 'functionality_storage'),
  personalization_storage: getConfirmState(storage, 'personalization_storage'),
  security_storage: getConfirmState(storage, 'security_storage'),
});

const onSuccess = () => {
    const lang = data.overideLang || data.automaticLang || data.defaultLang;
      callInWindow
    ('cookieconsent.run', {
      "notice_banner_type": "headline",
      "consent_type": "express",
      "palette": "light",
      "language": lang,
      //"debug": 'true',
      "page_load_consent_levels": ["strictly-necessary"],
      "notice_banner_reject_button_hide": false,
      "preferences_center_close_button_hide": false,
      "page_refresh_confirmation_buttons": false,
      "website_privacy_policy_url": getPolicyUrl(lang),
    });
    dataLayerPush({'lang': lang});
    data.gtmOnSuccess();
};

injectScript('https://www.termsfeed.com/public/cookie-consent/4.0.0/cookie-consent.js', onSuccess, data.gtmOnFailure);


// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "cookieconsent.run"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.termsfeed.com/public/cookie-consent/4.0.0/cookie-consent.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_cookies",
        "versionId": "1"
      },
      "param": [
        {
          "key": "cookieAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "cookieNames",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "cookie_consent_level"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 23.02.2022, 11:02:51

